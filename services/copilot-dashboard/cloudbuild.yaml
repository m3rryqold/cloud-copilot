# Cloud Build configuration for copilot-dashboard
# Deploys to Cloud Run in europe-west1
# Uses Artifact Registry for container images
# Fetches deployed agent URLs and injects as environment variables

substitutions:
  _REGION: europe-west1
  _REPOSITORY: k8s-copilot-repo
  _SERVICE_NAME: copilot-dashboard

steps:
  # Build the container image
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '-t'
      - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/copilot-dashboard:$COMMIT_SHA'
      - '-t'
      - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/copilot-dashboard:latest'
      - './services/copilot-dashboard'

  # Push the container image to Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/copilot-dashboard:$COMMIT_SHA'

  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/copilot-dashboard:latest'

  # Get K8s Copilot and Cost Copilot URLs
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: bash
    args:
      - '-c'
      - |
        echo "Fetching K8s Copilot URL..."
        gcloud run services describe k8s-copilot --region=${_REGION} --format='value(status.url)' > /workspace/k8s_url.txt || echo "https://k8s.agents.hunt3r.dev" > /workspace/k8s_url.txt
        echo "Fetching Cost Copilot URL..."
        gcloud run services describe cost-copilot --region=${_REGION} --format='value(status.url)' > /workspace/cost_url.txt || echo "https://cost.agents.hunt3r.dev" > /workspace/cost_url.txt
        echo "K8s Copilot URL: $(cat /workspace/k8s_url.txt)"
        echo "Cost Copilot URL: $(cat /workspace/cost_url.txt)"

  # Deploy to Cloud Run with dynamic agent URLs
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: bash
    args:
      - '-c'
      - |
        K8S_URL=$(cat /workspace/k8s_url.txt)
        COST_URL=$(cat /workspace/cost_url.txt)
        gcloud run deploy ${_SERVICE_NAME} \
          --image ${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/copilot-dashboard:$COMMIT_SHA \
          --region ${_REGION} \
          --platform managed \
          --allow-unauthenticated \
          --port 8080 \
          --memory 512Mi \
          --cpu 1 \
          --min-instances 0 \
          --max-instances 3 \
          --timeout 300 \
          --set-env-vars VITE_K8S_COPILOT_URL=$K8S_URL,VITE_COST_COPILOT_URL=$COST_URL

# Store images in Artifact Registry
images:
  - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/copilot-dashboard:$COMMIT_SHA'
  - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/copilot-dashboard:latest'

# Build options - cost-efficient settings
options:
  machineType: 'E2_HIGHCPU_8'
  logging: CLOUD_LOGGING_ONLY

# Timeout for the entire build
timeout: '600s'
